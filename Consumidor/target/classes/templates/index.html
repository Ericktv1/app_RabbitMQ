<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <title>Restaurante · Pedidos & Facturas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{--bg:#0b1020; --panel:#11183a; --text:#eaf1ff; --muted:#8ea2c8;
          --border:rgba(255,255,255,.12); --brand:#6aa4ff; --ok:#19c37d; --danger:#ff6b6b;
          --radius:18px; --shadow:0 12px 30px rgba(0,0,0,.35);}
        body{margin:0; font-family:ui-sans-serif,system-ui; background:linear-gradient(180deg,#0a0f23 0%,#0b1020 100%); color:var(--text);}
        .container{max-width:1100px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:22px}
        h1{margin:0 0 6px 0; font-size:28px}
        .card{background:linear-gradient(180deg,#0e1540 0%, #0d1335 100%);border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);}
        .panel{padding:16px 18px}
        .toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
        .btn{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#16245d,#0d1745);color:var(--text);padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;}
        .btn.ok{background:linear-gradient(180deg,#2fe09d,#19c37d); color:#041d12; border:none}
        .btn.danger{background:linear-gradient(180deg,#ff817e,#ff6b6b); color:#2b0606; border:none}
        table{width:100%; border-collapse:collapse; border-radius:14px}
        th,td{padding:12px 10px; border-bottom:1px solid var(--border)}
        th{background:rgba(255,255,255,.04); text-align:left}
        .right{text-align:right}
        .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
        .PENDIENTE{background:#2e3352;color:#c7d2ff}
        .ACEPTADO{background:#133c2a;color:#bff3df}
        .DENEGADO{background:#4a1b1b;color:#ffd2d2}
    </style>
</head>
<body>
<div class="container">
    <section class="card">
        <div class="panel">
            <div class="toolbar"><h1>Pedidos pendientes</h1><button id="refreshOrders" class="btn">Actualizar</button></div>
            <div class="muted">Acepta o deniega cada pedido.</div>
            <table>
                <thead><tr><th>ID</th><th>Cliente</th><th>Items</th><th class="right">Total</th><th>Estado</th><th class="right">Acción</th></tr></thead>
                <tbody id="tbOrders"></tbody>
            </table>
        </div>
    </section>

    <section class="card">
        <div class="panel">
            <div class="toolbar"><h1>Facturas</h1><button id="refreshInvoices" class="btn">Actualizar</button></div>
            <table>
                <thead><tr><th>OrderID</th><th>Cliente</th><th class="right">Subtotal</th><th class="right">IVA</th><th class="right">Total</th></tr></thead>
                <tbody id="tbInvoices"></tbody>
            </table>
        </div>
    </section>
</div>

<script>
    const fmtCOP = n => Number(n).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});

    async function loadOrders(){
      const res = await fetch('/orders/pending'); const orders = await res.json();
      const tb = document.getElementById('tbOrders'); tb.innerHTML='';

      if(orders.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--muted); padding:20px">No hay pedidos pendientes</td></tr>';
        return;
      }

      orders.forEach(o=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${o.id}</td><td>${o.customerName}</td>
          <td>${(o.items||[]).join(', ')}</td>
          <td class="right">${fmtCOP(o.total)}</td>
          <td><span class="badge ${o.status}">${o.status}</span></td>
          <td class="right">
            <button class="btn ok" onclick="act('${o.id}',true)">Aceptar</button>
            <button class="btn danger" onclick="act('${o.id}',false)">Denegar</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    async function loadInvoices(){
      const res = await fetch('/invoices'); const invoices = await res.json();
      const tb = document.getElementById('tbInvoices'); tb.innerHTML='';

      if(invoices.length === 0) {
        tb.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--muted); padding:20px">No hay facturas generadas</td></tr>';
        return;
      }

      invoices.forEach(i=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${i.orderId}</td><td>${i.customerName}</td>
          <td class="right">${fmtCOP(i.subtotal)}</td>
          <td class="right">${fmtCOP(i.tax)}</td>
          <td class="right">${fmtCOP(i.total)}</td>`;
        tb.appendChild(tr);
      });
    }

    async function act(id,ok){
      const url = ok?`/orders/${id}/accept`:`/orders/${id}/deny`;
      await fetch(url,{method:'POST'}); await loadOrders(); await loadInvoices();
    }

    document.getElementById('refreshOrders').onclick=loadOrders;
    document.getElementById('refreshInvoices').onclick=loadInvoices;
    setInterval(()=>{loadOrders();loadInvoices();},4000);
    loadOrders(); loadInvoices();
</script>
</body>
</html>